---------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/jiangchenxi/GenderGapsAcademies/tables/pooled_counterfactual.log
  log type:  text
 opened on:  17 Jun 2023, 10:19:27

. 
. 
. global psych_journals JEPG PR PS TiCS PB JPSP ARP PNAS AP CD Cog CP DP

. global math_journals AIM AJM AM AP AS ActaM CM CMP DMJ IM JAMS JASA JCP PNAS TAMS

. global econ_journals AER ECTA JE JET JPE QJE REStud RAND JEP JEL REStat JF JME JPubE 

. scalar define boost = 100

. 
. cap erase tables/counterfactuals/table_pooled_panelb_`=boost'.txt

. cap erase tables/counterfactuals/table_pooled_panelb_`=boost'.xls

. 
. 
. foreach field in psych econ math {
  2.         noisily display "Generating estimates for `field'..." _n
  3. 
.         if "`field'" == "psych" {
  4.                 use "${root}/psych/output/fellows_matched_rectangular_citation.dta", clear
  5.         }
  6.         else if "`field'" == "math" {   
  7.                 use "${root}/math/output/fellows_matched_rectangular_citation.dta", clear
  8.         }       
  9.         else if "`field'" == "econ" {
 10.                 use "${root}/econ/output/regression_dataset_NAS_AAAS.dta", clear
 11.         }
 12.         drop if years_lastpub > 18 & year !=.
 13.         drop if year > 2019
 14. 
.         if "`field'" == "psych" | "`field'" == "math" {
 15.                 * merge back flags
.                 merge m:1 author using "${root}/`field'/output/AAAS_fellows_clean.dta", ///
>                         keepusing(AAAS_flags) keep(1 3) nogen
 16.                         
.                 merge m:1 author using "${root}/`field'/output/NAS_fellows_clean.dta", ///
>                         keepusing(primary_NAS) keep(1 3) nogen
 17.                 * merge deaths
.                 merge m:1 author using "${root}/`field'/output/urap_death.dta", keep(1 3) nogen
 18.                 destring death, replace force
 19.                 drop if (year > death)
 20.                 
.         }
 21.         else {
 22.                 merge m:1 author using "${root}/econ/input/AAAS_secondary.dta", ///
>                         keepusing(author subfield*) keep(1 3)
 23.                 replace AAAS_flags = 3 if subfield_pdf == "Economics"
 24.                 replace AAAS_flags = 4 if subfield_website == "Economics"
 25. 
.                 drop _m
 26.                 
.         }
 27.         keep author Female Ambiguous year *_cumulative years_firstpub ///
>                 fellow_AAAS new_fellow_AAAS year_appointed_AAAS ever_fellow_AAAS AAAS_flags ///
>                 fellow_NAS new_fellow_NAS year_appointed_NAS ever_fellow_NAS primary_NAS 
 28.         cap drop single* 
 29.         cap drop first*
 30. 
.         * fill in missing for NAS
.         foreach var in fellow_NAS new_fellow_NAS ever_fellow_NAS {
 31.                 replace `var' = 0 if missing(`var')
 32.         }
 33.         
.         * condition on gendered
.         drop if Ambiguous == 1
 34.         
.         rename (new_fellow_AAAS fellow_AAAS ever_fellow_AAAS) (new_fellow1 fellow1 ever_fellow1)
 35.         rename (new_fellow_NAS fellow_NAS ever_fellow_NAS) (new_fellow2 fellow2 ever_fellow2)
 36. 
.         reshape long new_fellow fellow ever_fellow, i(author year) j(fellowship)
 37. 
.         order author year Female fellowship new_fellow fellow year_appointed_AAAS year_appointed_NAS 
 38.         tostring fellowship, replace
 39.         replace fellowship = "AAAS" if fellowship == "1" 
 40.         replace fellowship = "NAS" if fellowship == "2"
 41.         encode fellowship, gen(nfellowship)
 42.         drop fellowship 
 43.         rename (nfellowship) (fellowship)
 44.         sort fellowship author year
 45.                 
. 
.         * generate filter for NAS primary fellows. For secondary fellows, we keep them in 
.         * the risk set up to and including the year they are elected, but are not counted as
.         * a fellow and then dropped after that year
.         gen NAS_sample = (fellow == 0 | new_fellow == 1) if fellowship == 2
 46.         replace new_fellow = 0 if primary_NAS == 0 & fellowship == 2
 47.         replace NAS_sample = 0 if year > year_appointed_NAS & primary_NAS == 0 & fellowship == 2
 48. 
.         * same for AAAS 
.         gen AAAS_sample = (fellow == 0 | new_fellow == 1) if fellowship == 1
 49.         replace new_fellow = 0 if ((AAAS_flags == 3 & year_appointed_AAAS >= 2000 & year_appointed_AAAS != .) | 
>  (AAAS_flags == 4 & year_appointed_AAAS < 2000 & year_appointed_AAAS != .)) & fellowship == 1
 50.         replace AAAS_sample = 0 if year > year_appointed_AAAS & ((AAAS_flags == 3 & year_appointed_AAAS >= 2000 
> & year_appointed_AAAS != .) |  (AAAS_flags == 4 & year_appointed_AAAS < 2000 & year_appointed_AAAS != .)) & fellows
> hip == 1
 51. 
. 
.         * drop if already fellow before 1960
.         replace NAS_sample = 0 if year_appointed_NAS < 1960 & !missing(year_appointed_NAS)
 52.         replace AAAS_sample = 0 if year_appointed_AAAS < 1960 & !missing(year_appointed_AAAS)
 53. 
.         * by decade * Female variable 
.         gen Female_1960_1970 = Female * (year >= 1960 & year <= 1979)
 54.         local list_decade 1980 1990 2000 2010
 55.         foreach decade in `list_decade'{
 56.                 gen Female_`decade' = Female * (floor(year/10)*10== `decade')
 57.         }
 58.         
.         * Counterfactually boost female's citation and publications
.         local loopjournals = "`field'_journals"
 59.         foreach journal in $`loopjournals' {
 60.                 replace `journal'_cumulative = `journal'_cumulative * (1+Female * boost/100) 
 61.                 replace `journal'_cite_cumulative = `journal'_cite_cumulative * (1+ Female * boost/100) 
 62.         } 
 63.         
.         
.         cap drop multi*
 64.         egen total_cite_cumulative = rowtotal(*_cite_cumulative)
 65.         gen asinh_cite_total = asinh(total_cite_cumulative)
 66. 
.         * Controls * 3 20-year time intervals 
.         ** time interval dummy  
.         gen decades_1960 = (year <= 1979)
 67.         gen decades_1980 = (year < 2000 & year > 1979)
 68.         gen decades_2000 = (year > 1999)
 69. 
.         * years since first publication 
.         gen firstpub_10 = (years_firstpub < 20 & years_firstpub >= 10)
 70.         gen firstpub_20 = (years_firstpub < 30 & years_firstpub >= 20)
 71.         gen firstpub_30 = (years_firstpub >= 30)
 72.         drop years_firstpub
 73.         
.         local loopjournals = "`field'_journals"
 74.         foreach journal in $`loopjournals' {
 75.                 gen asinh_`journal'_cite = asinh(`journal'_cite_cumulative)
 76.                 drop `journal'_cite_cumulative
 77.         } 
 78.         drop total_cite_cumulative
 79.         
.         gen decade = . 
 80.         local list_decade 1930 1940 1950 1960 1970 1980 1990 2000 2010 
 81.         foreach decade in `list_decade'{
 82.                 replace decade = `decade' if floor(year/10)*10 == `decade'
 83.         }
 84.         
.         
.         rename nm_paper_cumulative nm_paper_cumulative_total
 85.         
.         gen year_1960_1979 = (year >= 1960 & year <= 1979)
 86.         gen year_1980_1999 = (year >= 1980 & year <= 1999)
 87.         gen year_2000_2019 = (year >= 2000 & year <= 2019)
 88.         
.         cap drop topcite
 89.         gen topcite = . 
 90.         levelsof decade, local(levels)
 91.         foreach d in `levels'{
 92.                 _pctile asinh_cite_total if decade == `d' & AAAS_sample == 1, p(90 95 99 99.5)
 93.                 return list
 94.                 
.                 replace topcite = 1 if asinh_cite_total < r(r1) & decade == `d' & AAAS_sample == 1
 95.                 replace topcite = 2 if asinh_cite_total < r(r2) & asinh_cite_total >= r(r1) & decade == `d' & AA
> AS_sample == 1
 96.                 replace topcite = 3 if asinh_cite_total < r(r3) & asinh_cite_total >= r(r2) & decade == `d' & AA
> AS_sample == 1
 97.                 replace topcite = 4 if asinh_cite_total < r(r4) & asinh_cite_total >= r(r3) & decade == `d' & AA
> AS_sample == 1
 98.                 replace topcite = 5 if asinh_cite_total >= r(r4) & decade == `d' & AAAS_sample == 1
 99.                 
.                 _pctile asinh_cite_total if decade == `d' & NAS_sample == 1, p(90 95 99 99.5)
100.                 return list
101.                 
.                 replace topcite = 1 if asinh_cite_total < r(r1) & decade == `d' & NAS_sample == 1
102.                 replace topcite = 2 if asinh_cite_total < r(r2) & asinh_cite_total >= r(r1) & decade == `d' & NA
> S_sample == 1
103.                 replace topcite = 3 if asinh_cite_total < r(r3) & asinh_cite_total >= r(r2) & decade == `d' & NA
> S_sample == 1
104.                 replace topcite = 4 if asinh_cite_total < r(r4) & asinh_cite_total >= r(r3) & decade == `d' & NA
> S_sample == 1
105.                 replace topcite = 5 if asinh_cite_total >= r(r4) & decade == `d' & NAS_sample == 1
106.                 
.         }
107.         
.         logit new_fellow ///
>                         Female_2000 Female_2010 (c.asinh_cite_total c.*_cite c.*_cumulative i.topcite firstpub_*)#f
> ellowship year#fellowship /// 
>                         if (NAS_sample == 1 | AAAS_sample == 1) & year < 2020 & year >= 2000, cluster(author) diffi
> cult iterate(20)
108.         estimates store `field'_b
109.         outreg2 using tables/counterfactuals/table_pooled_panelb_`=boost'.xls, excel bdec(3) sdec(3) append adds
> tat(Log-Likelihood, e(ll), R2, e(r2_p), Sample Size, e(N), Degrees of Freedom of the Model, e(df_m))
110.          
.                         
.         local cite asinh_*_cite
111. 
. }
Generating estimates for psych...

(645,162 observations deleted)
(65,699 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                       922,196
        from master                   922,196  
        from using                          0  

    Matched                            14,831  
    -----------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                       929,887
        from master                   929,887  
        from using                          0  

    Matched                             7,140  
    -----------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                       921,107
        from master                   921,107  
        from using                          0  

    Matched                            15,920  
    -----------------------------------------
death: contains nonnumeric characters; replaced as int
(921192 missing values generated)
(2,190 observations deleted)
(238 real changes made)
(238 real changes made)
(238 real changes made)
(95,282 observations deleted)
(j = 1 2)

Data                               Wide   ->   Long
-----------------------------------------------------------------------------
Number of observations          839,555   ->   1,679,110   
Number of variables                  29   ->   27          
j variable (2 values)                     ->   fellowship
xij variables:
                new_fellow1 new_fellow2   ->   new_fellow
                        fellow1 fellow2   ->   fellow
              ever_fellow1 ever_fellow2   ->   ever_fellow
-----------------------------------------------------------------------------
fellowship was byte now str1
variable fellowship was str1 now str4
(839,555 real changes made)
(839,555 real changes made)
(839,555 missing values generated)
(19 real changes made)
(0 real changes made)
(839,555 missing values generated)
(34 real changes made)
(0 real changes made)
(645 real changes made)
(2,401 real changes made)
(64,430 real changes made)
variable JEPG_cite_cumulative not found
r(111);

end of do-file

r(111);

. do "/var/folders/bq/58gpldbn7yjd0j9lg6_5wj4h0000gn/T//SD01800.000000"

. eststo clear

. clear

. set matsize 11000
set matsize ignored.
    Matrix sizes are no longer limited by c(matsize) in modern Statas.  Matrix sizes are now limited by edition of
    Stata.  See limits for more details.

. 
. cd "~/GenderGapsAcademies"
/Users/jiangchenxi/GenderGapsAcademies

. global root "~/GenderGapsAcademies/data"

. 
. cap log close
